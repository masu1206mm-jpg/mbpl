<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>(偽)えむびーてぃーあいPlus</title>
  <meta name="description" content="3択×100問の超具体派 性格診断。(偽)えむびーてぃーあいPlus" />
  <style>
    :root{
      --bg:#0b0f19;
      --card: rgba(255,255,255,.07);
      --card2: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --line: rgba(255,255,255,.14);
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --r: 18px;
      --max: 980px;

      --accent:#B99CFF;
      --accent2:#6EF2FF;
      --accent3:#FF7C9E;

      --btn: rgba(255,255,255,.10);
      --btn2: rgba(255,255,255,.18);
      --good:#7CFFB2;
      --warn:#FFD37C;
      --bad:#FF7C9E;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", "Helvetica Neue", Arial;
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(185,156,255,.22), transparent 60%),
        radial-gradient(900px 500px at 85% 20%, rgba(110,242,255,.18), transparent 60%),
        radial-gradient(900px 600px at 50% 100%, rgba(255,124,158,.10), transparent 60%),
        linear-gradient(180deg, #070a12 0%, #0b0f19 45%, #070a12 100%);
      min-height:100vh;
      padding: 16px;
      padding-bottom: 40px;
    }
    .wrap{max-width:var(--max); margin:0 auto;}
    .top{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap: 12px; margin-top: 6px; margin-bottom: 12px;
    }
    .brand{display:flex; flex-direction:column; gap:6px;}
    .title{
      font-weight: 1000;
      letter-spacing: .02em;
      line-height: 1.08;
      font-size: clamp(20px, 3.5vw, 34px);
      margin:0;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      -webkit-background-clip:text;
      background-clip:text;
      color: transparent;
    }
    .subtitle{
      margin:0;
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      user-select:none;
      backdrop-filter: blur(8px);
      white-space:nowrap;
    }
    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .cardHead{
      padding: 14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .progressWrap{display:flex; flex-direction:column; gap:6px; width:100%;}
    .metaRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      color: var(--muted);
      font-size: 12px;
    }
    .bar{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
    }
    .bar > div{
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(185,156,255,.95), rgba(110,242,255,.95));
      transition: width .22s ease;
    }
    .content{padding: 14px;}
    .q{
      font-size: clamp(16px, 2.7vw, 20px);
      line-height: 1.45;
      font-weight: 900;
      margin:0 0 12px 0;
    }
    .choices{display:grid; grid-template-columns:1fr; gap:10px;}
    .btn{
      width:100%;
      padding: 14px 14px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: var(--btn);
      color: var(--text);
      text-align:left;
      font-size: 16px;
      line-height: 1.25;
      cursor:pointer;
      transition: transform .06s ease, background .16s ease, border-color .16s ease;
      display:flex; align-items:flex-start; gap:10px;
    }
    .btn:hover{background: var(--btn2); border-color: rgba(255,255,255,.24);}
    .btn:active{transform: scale(.995);}
    .tag{
      font-size: 12px;
      color: rgba(255,255,255,.78);
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      padding: 3px 8px;
      border-radius: 999px;
      margin-top: 2px;
      flex: 0 0 auto;
    }
    .btnText{flex:1}
    .help{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.5;
    }
    .controls{
      margin-top: 14px;
      display:flex; flex-wrap:wrap; gap:10px;
      justify-content:space-between;
      align-items:center;
    }
    .smallBtns{display:flex; gap:10px; flex-wrap:wrap;}
    .ghost{
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      cursor:pointer;
      font-size: 13px;
    }
    .ghost:hover{background: rgba(255,255,255,.10); color: rgba(255,255,255,.78);}
    .primary{
      padding: 10px 14px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(90deg, rgba(185,156,255,.95), rgba(110,242,255,.95));
      color: #0b0f19;
      font-weight: 1000;
      cursor:pointer;
      font-size: 13px;
    }
    .primary:hover{filter: brightness(1.03);}
    .hide{display:none !important;}

    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
    @media (max-width: 760px){ .grid2{grid-template-columns:1fr;} }

    .panel{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      border-radius: 16px;
      padding: 12px;
    }
    .panel h3{
      margin:0 0 8px 0;
      font-size: 14px;
      letter-spacing:.02em;
      color: rgba(255,255,255,.88);
    }
    .panel p, .panel li{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.55;
    }

    .resultTitle{
      font-size: clamp(20px, 4vw, 34px);
      font-weight: 1000;
      margin: 4px 0 10px;
      line-height: 1.12;
      background: linear-gradient(90deg, var(--accent3), var(--accent), var(--accent2));
      -webkit-background-clip:text;
      background-clip:text;
      color: transparent;
    }
    .badgeRow{display:flex; flex-wrap:wrap; gap:8px; margin: 6px 0 12px;}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: rgba(255,255,255,.80);
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.75);
      color: rgba(255,255,255,.9);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      backdrop-filter: blur(8px);
      z-index: 50;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1 class="title">(偽)えむびーてぃーあいPlus</h1>
        <p class="subtitle">3択×100問／全部「具体的な場面」。<b>否定・中立・肯定</b>でサクサク答えるやつ。</p>
      </div>
      <div class="pill">📱スマホ最適化 / 途中保存あり</div>
    </div>

    <div class="card" id="app">
      <div class="cardHead">
        <div class="progressWrap">
          <div class="metaRow">
            <div id="stepText">準備中…</div>
            <div id="saveText">保存: ON</div>
          </div>
          <div class="bar"><div id="barFill"></div></div>
        </div>
      </div>

      <!-- Intro -->
      <div class="content" id="screenIntro">
        <p class="q">ルールは簡単。ぜんぶ “自分が主人公” で想像して選ぶだけ。</p>

        <div class="grid2">
          <div class="panel">
            <h3>✅ 回答形式（3択）</h3>
            <ul>
              <li><b>否定</b>：やらん／避ける／黙る 等</li>
              <li><b>中立</b>：様子見る／相談する／状況次第 等</li>
              <li><b>肯定</b>：やる／向き合う／言う 等</li>
            </ul>
          </div>
          <div class="panel">
            <h3>📌 この診断の狙い</h3>
            <p>
              「性格＝気分」じゃなく、<b>やらかし・緊急・人間関係</b>みたいな場面で出る
              “反応パターン”を拾う。だから質問は多め（100問）。
            </p>
            <p style="margin-top:8px; font-size:11px; color:rgba(255,255,255,.52);">
              ※これは娯楽コンテンツ。医療・心理の専門判断の代わりにはならんよ。
            </p>
          </div>
        </div>

        <div class="controls">
          <div class="smallBtns">
            <button class="ghost" id="resetAll">最初から（データ削除）</button>
          </div>
          <button class="primary" id="startBtn">開始する（100問）</button>
        </div>
      </div>

      <!-- Quiz -->
      <div class="content hide" id="screenQuiz">
        <p class="q" id="qText">質問</p>

        <div class="choices" id="choices"></div>

        <div class="help" id="helpText">
          迷ったら「中立」でOK。盛らなくていい。普段の自分で選んでな。
        </div>

        <div class="controls">
          <div class="smallBtns">
            <button class="ghost" id="backBtn">ひとつ戻る</button>
            <button class="ghost" id="skipBtn">保留（中立で進む）</button>
          </div>
          <button class="primary" id="toResultBtn">結果を見る</button>
        </div>
      </div>

      <!-- Result -->
      <div class="content hide" id="screenResult">
        <div class="badgeRow" id="badges"></div>
        <div class="resultTitle" id="resultTitle">結果</div>

        <div class="grid2">
          <div class="panel">
            <h3>あなたはこういう人物</h3>
            <p id="desc"></p>
          </div>
          <div class="panel">
            <h3>恋愛で向いてる相手</h3>
            <p id="love"></p>
          </div>
          <div class="panel">
            <h3>向いてる職業</h3>
            <p id="job"></p>
          </div>
          <div class="panel">
            <h3>好きそうなYouTube/娯楽</h3>
            <p id="media"></p>
          </div>
        </div>

        <div class="controls">
          <div class="smallBtns">
            <button class="ghost" id="shareBtn">結果テキストをコピー</button>
            <button class="ghost" id="restartBtn">もう一回やる</button>
          </div>
          <button class="primary" id="homeBtn">トップへ</button>
        </div>
      </div>

    </div>
  </div>

  <div class="toast" id="toast">コピーしたで</div>

  <script>
    // ========== 設定 ==========
    const STORAGE_KEY = "fake_mbtiai_plus_v1";

    const $ = (id) => document.getElementById(id);

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 1200);
    }

    function saveState(state){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){}
    }
    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : null;
      }catch(e){ return null; }
    }
    function clearState(){
      try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
    }

    function showScreen(which){
      $("screenIntro").classList.add("hide");
      $("screenQuiz").classList.add("hide");
      $("screenResult").classList.add("hide");
      $(which).classList.remove("hide");
    }

    function setProgress(i, total){
      const pct = total ? Math.round((i/total)*100) : 0;
      $("barFill").style.width = pct + "%";
      $("stepText").textContent = total ? `Q${Math.min(i+1,total)} / ${total}` : "準備中…";
    }

    // ここから下は「質問100問」「タイプ30個」「採点ロジック」を入れる
    // → パート2で追加する！

    // ========== 仮のデータ（パート2で上書き） ==========
    const QUESTIONS = []; // パート2で100問入れる
    const TYPES = [];     // パート2で30タイプ入れる

    let state = {
      idx: 0,
      answers: [], // -1:否定 / 0:中立 / +1:肯定
      scores: {},  // 各軸の点数（パート2で使う）
      finished: false
    };

    function boot(){
      const saved = loadState();
      if(saved && saved.answers && typeof saved.idx === "number"){
        state = saved;
        $("saveText").textContent = "保存: ON（復元）";
        if(state.finished){
          showScreen("screenResult");
          setProgress(QUESTIONS.length ? QUESTIONS.length-1 : 0, QUESTIONS.length || 100);
        }else if(state.idx > 0 || (state.answers && state.answers.length)){
          showScreen("screenQuiz");
        }else{
          showScreen("screenIntro");
        }
      }else{
        showScreen("screenIntro");
      }
      setProgress(state.idx, QUESTIONS.length || 100);
    }

    // ボタン
    $("resetAll").addEventListener("click", ()=>{
      clearState();
      state = {idx:0, answers:[], scores:{}, finished:false};
      toast("データ消したで");
      showScreen("screenIntro");
      setProgress(0, QUESTIONS.length || 100);
    });

    $("startBtn").addEventListener("click", ()=>{
      showScreen("screenQuiz");
      // 実描画はパート2で実装
      toast("スタート！");
    });

    $("homeBtn").addEventListener("click", ()=>{
      showScreen("screenIntro");
      toast("トップへ");
    });

    $("restartBtn").addEventListener("click", ()=>{
      clearState();
      state = {idx:0, answers:[], scores:{}, finished:false};
      showScreen("screenQuiz");
      toast("リスタート！");
      // 実描画はパート2で
    });

    $("shareBtn").addEventListener("click", async ()=>{
      const text =
`(偽)えむびーてぃーあいPlus 結果
・${$("resultTitle").textContent}
・${$("desc").textContent}`;
      try{
        await navigator.clipboard.writeText(text);
        toast("結果コピーしたで");
      }catch(e){
        toast("コピー失敗…");
      }
    });

    // 戻る/保留/結果 はパート2で動作追加
    $("backBtn").addEventListener("click", ()=> toast("（パート2で実装）"));
    $("skipBtn").addEventListener("click", ()=> toast("（パート2で実装）"));
    $("toResultBtn").addEventListener("click", ()=> toast("（パート2で実装）"));

    boot();
  </script>

  <!-- ここにパート2を貼る -->
<script>
/* =========================
   (偽)えむびーてぃーあいPlus - PART2（作り直し）
   ✅ 100問 / 3択 / 保存
   ✅ 質問シャッフル（開始時に1回だけ。順番は保存される）
   ✅ ひとつ戻る → その場で選び直しOK（スコアも差し引き）
   ✅ 回答は「元質問ID」に紐付け（PART3の採点が崩れにくい）
========================= */

(function(){
  // ---------- 100問データ（質問文 q にGLAMワードを少し増やしている） ----------
  const QUESTIONS_BASE = [
    // 1-10：ミス/やらかし
    { q:"好きな人の前で、盛大におならした。", a:"無言でなかったことにする", b:"笑ってごまかして話題変える", c:"素直に謝って自虐で回収する", axes:{C:1,E:1} },
    { q:"バイト中、お客さんにコーヒーをこぼした。", a:"固まって店長に丸投げ", b:"まず謝って指示を仰ぐ", c:"即謝罪→応急処置→代替案まで提案", axes:{C:1} },
    { q:"LINEを誤爆して、変なスタンプを先生に送った。", a:"既読つく前に消して祈る", b:"軽く謝ってスルーする", c:"ちゃんと謝って用件も一緒に送る", axes:{C:1} },
    { q:"友達の前で滑って転んだ。", a:"痛くないフリして無言", b:"笑って『今の無し』で流す", c:"『今の撮れた？』ってネタにする", axes:{E:1} },
    { q:"大事な提出物、締切1時間前に気づいた。", a:"諦める（言い訳を考える）", b:"とりあえず出来るだけ出す", c:"最速で仕上げて追記説明も添える", axes:{C:1} },
    { q:"遅刻確定。電車が止まった。", a:"今日はもう行かない", b:"親/友達/AIに相談して決める", c:"遅れてでも行く（連絡して向かう）", axes:{C:1} },
    { q:"飲食で、注文を間違えて出した。", a:"バレないなら放置", b:"様子見て、言われたら対応", c:"自分から言って作り直す", axes:{C:1} },
    { q:"友達に『さっきの言い方キツい』と言われた。", a:"『は？』って反発する", b:"一旦黙って落ち着く", c:"謝って、どう言えばよかったか聞く", axes:{A:1} },
    { q:"会話中、相手が明らかにテンション下がった。", a:"気づかないフリで進める", b:"距離感を調整する", c:"『今の嫌やった？』って確認する", axes:{A:1} },
    { q:"大勢の前で名前を呼び間違えた。", a:"スルーする", b:"軽く『ごめん』で済ます", c:"ちゃんと謝って言い直す", axes:{C:1} },

    // 11-20：対人/空気/人間関係
    { q:"グループLINEで自分だけ返事が遅れてる。", a:"放置する", b:"スタンプだけ送る", c:"用件＋一言添えて返す", axes:{A:1} },
    { q:"友達が明らかに病んでそう。", a:"触れない（面倒は避ける）", b:"軽く様子を聞く", c:"時間作ってちゃんと話聞く", axes:{A:1} },
    { q:"悪口大会が始まった。", a:"ノリで参加する", b:"聞くだけで流す", c:"話題変える/離脱する", axes:{A:1} },
    { q:"友達が嘘ついてるっぽい。", a:"証拠集めて詰める", b:"一旦様子見る", c:"優しく確認する", axes:{A:1} },
    { q:"誘いを断りたいけど角が立ちそう。", a:"既読無視で逃げる", b:"やんわり理由つける", c:"正直に理由言って代案出す", axes:{A:1,C:1} },
    { q:"飲み会で輪に入れない人がいる。", a:"気づいてないフリ", b:"様子見ながらちょい話す", c:"こっちから話題振って巻き込む", axes:{A:1,E:1} },
    { q:"自分の話を遮られがち。", a:"黙る（諦める）", b:"隙を見て言い直す", c:"『今の続きいい？』って取り戻す", axes:{E:1} },
    { q:"相手が約束を守らないタイプ。", a:"即切る", b:"距離置く", c:"ルール作って改善試す", axes:{C:1} },
    { q:"恋人が『話聞いてない』って怒ってる。", a:"逆ギレする", b:"謝るけど深掘りしない", c:"何が嫌だったか具体的に聞く", axes:{A:1} },
    { q:"友達に借りた物を壊した。", a:"黙って返す", b:"正直に言って謝る", c:"謝罪＋弁償/代替案を先に出す", axes:{C:1} },

    // 21-30：判断/行動の速さ
    { q:"初めての場所で迷った。", a:"勘で突っ走る", b:"地図見てから動く", c:"人に聞く/確実ルート取る", axes:{C:1} },
    { q:"予定が急に空いた。", a:"家でダラダラする", b:"気分で決める", c:"やることリストを進める", axes:{C:1} },
    { q:"明日テスト、今夜ゲーム誘い。", a:"行く（テストは運）", b:"少しだけ参加", c:"断って勉強する", axes:{C:1} },
    { q:"買うか迷う高い服（ブランド）を見つけた。", a:"勢いで買う", b:"一晩寝かせる", c:"レビュー/予算/用途で検証して買う", axes:{C:1} },
    { q:"知らん番号から電話。", a:"即出る", b:"一旦出ずに検索する", c:"出ずに留守電/公式へ確認", axes:{C:1} },
    { q:"上司（先生）に質問したいが怖い。", a:"諦める", b:"友達/AIに聞いてから行く", c:"要点まとめて質問しに行く", axes:{E:1,C:1} },
    { q:"人前で発表、直前に緊張MAX。", a:"逃げたい", b:"深呼吸して淡々とやる", c:"むしろテンション上げていく", axes:{E:1} },
    { q:"旅行の計画。", a:"ノープランで行く", b:"ざっくりだけ決める", c:"時刻/予算/予約まで詰める", axes:{C:1} },
    { q:"レストラン、行列が長い。", a:"諦める", b:"周辺候補を探す", c:"並びながら最適化（予約/代替）", axes:{C:1} },
    { q:"新しい趣味始めたい。", a:"まず道具から揃える", b:"体験だけして判断", c:"目的→必要最低限で始める", axes:{C:1} },

    // 31-40：価値観/正義感/こだわり
    { q:"ルール違反して得してる人を見る。", a:"自分もやる", b:"気にしない", c:"納得いかず注意/通報する", axes:{A:1} },
    { q:"友達がズルした。", a:"笑って見逃す", b:"やめときって言う", c:"ちゃんと怒る/距離置く", axes:{A:1} },
    { q:"自分だけ損な役回り。", a:"我慢する", b:"次からは避ける", c:"最初から分担を提案する", axes:{E:1} },
    { q:"人に『それ非常識』と言われた。", a:"ムカつく", b:"一応考える", c:"理由を聞いて調整する", axes:{A:1} },
    { q:"服や髪型、流行より自分（盛り方も含む）。", a:"流行に寄せる", b:"半々にする", c:"自分の軸で決める", axes:{E:1} },
    { q:"SNSで叩かれてる人を見る。", a:"一緒に叩く", b:"スルーする", c:"事実確認して擁護/冷静化する", axes:{A:1} },
    { q:"誰も見てない場所のゴミ。", a:"放置", b:"気分次第", c:"拾って捨てる", axes:{A:1} },
    { q:"友達が陰で悪口言ってたと知る。", a:"晒す/やり返す", b:"距離置く", c:"本人と話して整理する", axes:{A:1} },
    { q:"損得よりも『筋』を通したい。", a:"そんなの要らん", b:"場合による", c:"筋優先で動く", axes:{A:1} },
    { q:"自分のミスを他人に押し付けられた。", a:"我慢する", b:"その場は飲むが後で言う", c:"その場で冷静に訂正する", axes:{E:1} },

    // 41-50：感情の扱い
    { q:"怒りが湧いた時の処理。", a:"即ぶつける", b:"一旦距離置く", c:"言語化して落ち着かせる", axes:{A:1} },
    { q:"落ち込んだ時。", a:"誰にも言わない", b:"仲良い人にだけ言う", c:"積極的に相談する", axes:{E:1} },
    { q:"泣きそうになる場面。", a:"隠す", b:"耐える", c:"出る時は出る（無理しない）", axes:{A:1} },
    { q:"失恋した。", a:"引きずる", b:"時間で回復", c:"切り替えて次行く", axes:{C:1} },
    { q:"褒められた。", a:"照れて否定", b:"ありがとうだけ言う", c:"素直に受け取って喜ぶ", axes:{E:1} },
    { q:"否定された。", a:"すぐ凹む/攻撃する", b:"一旦考える", c:"根拠を聞いて改善する", axes:{C:1} },
    { q:"不安で眠れない夜。", a:"スマホで逃げる", b:"音楽/風呂で落ち着く", c:"原因整理→明日の手順を作る", axes:{C:1} },
    { q:"気まずい空気。", a:"放置", b:"軽い話題で流す", c:"自分から整える", axes:{E:1} },
    { q:"自分の欠点を指摘された。", a:"反発する", b:"半分受け取る", c:"改善策まで聞く", axes:{C:1} },
    { q:"誰かに嫉妬した。", a:"攻撃/悪口", b:"距離置く", c:"自分の課題として分析する", axes:{C:1} },

    // 51-60：リスク/挑戦
    { q:"新しいバイト、時給高いが未知（夜職っぽい噂もある）。", a:"怖いから行かない", b:"情報集めて検討", c:"まず応募してみる", axes:{E:1} },
    { q:"投資で含み損。", a:"怖くて全部売る", b:"様子見", c:"理由確認してルール通り動く", axes:{C:1} },
    { q:"友達に起業の誘い。", a:"即断る", b:"条件を聞く", c:"小さく試す", axes:{C:1} },
    { q:"初対面の集まり。", a:"行かない", b:"顔だけ出す", c:"普通に参加して広げる", axes:{E:1} },
    { q:"運転/スポーツで危ない挑戦。", a:"やる", b:"やらない寄り", c:"安全確認してからやる", axes:{C:1} },
    { q:"秘密の告白を聞いた。", a:"誰かに言う", b:"迷う", c:"守る", axes:{A:1} },
    { q:"バイトで責任ある役を任された。", a:"避ける", b:"相談して受ける", c:"受けてやり切る", axes:{C:1} },
    { q:"苦手な人と同じ班。", a:"避ける", b:"必要最低限", c:"役割決めて上手く回す", axes:{C:1,A:1} },
    { q:"苦手科目、単位が危ない。", a:"祈る", b:"最低限やる", c:"計画立てて追い込む", axes:{C:1} },
    { q:"SNSで顔出しするか。", a:"しない", b:"限定で", c:"戦略的にやる", axes:{E:1} },

    // 61-70：コミュ力/表現
    { q:"初対面で何話す？", a:"相手に任せる", b:"共通点探す", c:"自分から話題出す", axes:{E:1} },
    { q:"会議/ゼミで黙ってしまう。", a:"ずっと黙る", b:"終盤だけ言う", c:"早めに一回は発言する", axes:{E:1} },
    { q:"話が長いと言われた。", a:"ムカつく", b:"意識する", c:"結論から言う練習する", axes:{C:1} },
    { q:"謝罪する時。", a:"軽く済ます", b:"必要最小限", c:"原因/再発防止まで言う", axes:{C:1} },
    { q:"誘い文句を考える時。", a:"雑に送る", b:"様子見の文面", c:"相手がYES出しやすい提案", axes:{C:1} },
    { q:"場を盛り上げたい。", a:"無理", b:"相手次第", c:"テンション上げて回す", axes:{E:1} },
    { q:"相手が落ち込んでる。", a:"放置", b:"一言だけ", c:"時間作って寄り添う", axes:{A:1} },
    { q:"ツッコミ/ボケ。", a:"どっちも苦手", b:"たまに", c:"やれる方で回す", axes:{E:1} },
    { q:"知らない話題が出た。", a:"黙る", b:"聞き役", c:"質問して吸収する", axes:{C:1} },
    { q:"褒め方。", a:"あんまり褒めない", b:"たまに", c:"具体的に褒める", axes:{A:1} },

    // 71-80：生活/セルフ管理
    { q:"財布落としたかも。", a:"諦める", b:"探すけど焦らない", c:"即カード停止→警察→ルート確認", axes:{C:1} },
    { q:"部屋が散らかる。", a:"放置", b:"気が向いたら片付ける", c:"ルール作って維持", axes:{C:1} },
    { q:"課題は締切いつ？", a:"当日", b:"前日", c:"余裕持って終わらす", axes:{C:1} },
    { q:"朝型にしたい。", a:"無理", b:"気分で", c:"仕組みで変える", axes:{C:1} },
    { q:"ダイエット/筋トレ。", a:"続かない", b:"ゆるくやる", c:"数値管理でやる", axes:{C:1} },
    { q:"急な体調不良。", a:"気合で行く", b:"様子見", c:"休む/受診/対策する", axes:{C:1} },
    { q:"寝る前スマホ。", a:"2時間", b:"少し", c:"なるべく避ける", axes:{C:1} },
    { q:"支出管理。", a:"してない", b:"ざっくり", c:"記録/予算組む", axes:{C:1} },
    { q:"嫌なタスク。", a:"先延ばし", b:"ギリで", c:"先に片付ける", axes:{C:1} },
    { q:"予定が崩れた。", a:"イラつく", b:"切り替える", c:"代替案を即作る", axes:{C:1} },

    // 81-90：SNS/承認欲求/界隈（GLAMワード濃いゾーン）
    { q:"投稿の反応が少ない。", a:"消す", b:"気にしない", c:"改善して再挑戦", axes:{E:1} },
    { q:"炎上してる話題。", a:"乗る", b:"眺める", c:"距離取る", axes:{A:1} },
    { q:"裏垢で愚痴りたい。", a:"やる", b:"たまに", c:"やらない（別の方法）", axes:{A:1} },
    { q:"キラキラ投稿を見る。", a:"病む", b:"無", c:"参考にする/モチベにする", axes:{C:1} },
    { q:"整形・美容にお金かける？（美容クリニック含む）", a:"否定", b:"必要なら", c:"投資としてガッツリ", axes:{E:1} },
    { q:"他人の成功がムカつく。", a:"叩きたくなる", b:"スルー", c:"分析して自分に活かす", axes:{C:1} },
    { q:"バズる企画思いついた。", a:"言うだけで終わる", b:"様子見", c:"すぐ試作して出す", axes:{C:1} },
    { q:"自撮りを上げる頻度（盛り写真）。", a:"ほぼ無い", b:"たまに", c:"割と上げる", axes:{E:1} },
    { q:"DMで知らん人から褒め。", a:"無視", b:"短く返す", c:"丁寧に返す", axes:{A:1} },
    { q:"夜職・ホスト・ブランドの話題が身近にある。", a:"無理、距離置く", b:"聞くぶんには聞く", c:"普通に興味ある/詳しく知りたい", axes:{E:1} },

    // 91-100：恋愛/将来/決断
    { q:"告白するなら。", a:"しない", b:"タイミング待つ", c:"行く", axes:{E:1} },
    { q:"相手が返信遅い。", a:"詰める", b:"様子見", c:"自分のペース保つ", axes:{A:1} },
    { q:"恋人が嫉妬してきた。", a:"面倒で冷める", b:"一旦落ち着かせる", c:"ルール作って安心させる", axes:{C:1,A:1} },
    { q:"将来やりたいことが曖昧。", a:"考えない", b:"そのうち", c:"仮でも目標置く", axes:{C:1} },
    { q:"大事な決断、怖い。", a:"避ける", b:"相談して決める", c:"情報集めて腹括る", axes:{C:1} },
    { q:"ミスを繰り返す自分。", a:"自己嫌悪で止まる", b:"気をつけるで終わる", c:"仕組みを変える", axes:{C:1} },
    { q:"周りに流されがち。", a:"流される", b:"半々", c:"自分の軸で選ぶ", axes:{E:1} },
    { q:"成功者の話を聞いた。", a:"嫉妬", b:"ふーん", c:"取り入れる", axes:{C:1} },
    { q:"『お前って結局どんな人？』と言われた。", a:"答えられん", b:"ざっくり言う", c:"言語化して言う", axes:{C:1} },
    { q:"100問終えた自分に一言。", a:"疲れた、もう無理", b:"まあ頑張った", c:"自分の傾向わかった", axes:{C:1} },
  ];

  // PART3が参照する「元の質問」は固定で持たせる（重要）
  window.QUESTIONS = QUESTIONS_BASE;

  // ---------- シャッフル ----------
  function makeOrder(n){
    const arr = Array.from({length:n}, (_,i)=>i);
    for(let i=n-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  // ---------- state拡張：order を保存する ----------
  // 既存stateがPART1で作られてる前提。なければ作る（保険）
  if(typeof window.state !== "object" || !window.state){
    window.state = { idx:0, answers:[], scores:{}, finished:false };
  }
  const state = window.state;

  // order がなければ作る（復元なら保持）
  const total = QUESTIONS_BASE.length;

  function ensureOrder(){
    if(!Array.isArray(state.order) || state.order.length !== total){
      state.order = makeOrder(total);
    }
  }

  // ---------- UI描画 ----------
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function getQidByPos(pos){
    ensureOrder();
    return state.order[pos];
  }

  function renderQuestion(){
    ensureOrder();

    // idx を範囲に収める
    state.idx = Math.max(0, Math.min(state.idx, total-1));

    // progress は「シャッフル順の進捗」
    setProgress(state.idx, total);

    const qid = getQidByPos(state.idx);
    const qObj = QUESTIONS_BASE[qid];

    $("qText").textContent = qObj.q;

    const wrap = $("choices");
    wrap.innerHTML = "";

    const current = state.answers[qid]; // ← 元IDで保存

    const opts = [
      { tag:"否定", text:qObj.a, val:-1 },
      { tag:"中立", text:qObj.b, val: 0 },
      { tag:"肯定", text:qObj.c, val:+1 },
    ];

    opts.forEach((o)=>{
      const btn = document.createElement("button");
      btn.className = "btn";
      // すでに選んでるやつは軽く目立たせる（CSS追加なしでinline）
      const isSel = (typeof current==="number" && current===o.val);
      btn.style.borderColor = isSel ? "rgba(110,242,255,.55)" : "";
      btn.style.background  = isSel ? "rgba(110,242,255,.12)" : "";

      btn.innerHTML = `<span class="tag">${o.tag}</span><div class="btnText">${escapeHtml(o.text)}</div>`;
      btn.addEventListener("click", ()=> choose(o.val));
      wrap.appendChild(btn);
    });

    $("toResultBtn").textContent = (state.idx >= total-1) ? "結果を見る（確定）" : "結果を見る（途中でも可）";
  }

  // ---------- 採点（PART2内はscoresに積む。PART3は自前計算でもOK） ----------
  function addScore(qObj, val){
    const axes = qObj.axes || {};
    for(const k in axes){
      state.scores[k] = (state.scores[k] || 0) + axes[k]*val;
    }
  }

  // ---------- 回答 ----------
  function choose(val){
    ensureOrder();

    const qid = getQidByPos(state.idx);
    const qObj = QUESTIONS_BASE[qid];
    const prev = state.answers[qid];

    // 選び直しなら差し引き
    if(typeof prev === "number"){
      addScore(qObj, -prev);
    }
    state.answers[qid] = val;
    addScore(qObj, val);

    // 次へ
    if(state.idx < total-1){
      state.idx++;
      saveState(state);
      renderQuestion();
    }else{
      saveState(state);
      goResult(); // PART2暫定 → PART3が上書きしてくれる想定
    }
  }

  // ---------- 戻る / 保留 ----------
  function back(){
    if(state.idx <= 0) return toast("これ以上戻れん");
    state.idx--;
    saveState(state);
    renderQuestion();
  }

  function skipNeutral(){
    // 今の問題を中立で確定（選び直しにも対応）
    choose(0);
  }

  // ---------- 結果（暫定） ----------
  function goResult(){
    state.finished = true;
    saveState(state);

    showScreen("screenResult");

    const answered = (state.answers||[]).filter(v=>typeof v==="number").length;
    $("badges").innerHTML =
      `<div class="badge">回答数 ${answered} / ${total}</div>` +
      `<div class="badge">保存ON</div>` +
      `<div class="badge">（結果はPART3が最終出力）</div>`;

    $("resultTitle").textContent = "結果生成中（PART3が担当）";
    $("desc").textContent  = "PART3が読み込まれていれば、この直後に最終結果へ上書きされるはず。";
    $("love").textContent  = "（PART3で出す）";
    $("job").textContent   = "（PART3で出す）";
    $("media").textContent = "（PART3で出す）";
  }

  // ---------- ボタン配線（PART1の仮を上書き） ----------
  // 既にPART1側で addEventListener 済みでも、ここで上から積む（動作OK）
  $("startBtn").addEventListener("click", ()=>{
    // 途中復帰
    if(state.answers && state.answers.some(v=>typeof v==="number")){
      state.finished = false;
      saveState(state);
      showScreen("screenQuiz");
      renderQuestion();
      toast("続きから再開（順番は保存されてる）");
      return;
    }
    // 新規開始：シャッフル作り直す
    state.idx = 0;
    state.answers = Array(total).fill(undefined);
    state.scores = {};
    state.finished = false;
    state.order = makeOrder(total);
    saveState(state);

    showScreen("screenQuiz");
    renderQuestion();
    toast("スタート！（質問シャッフル済み）");
  });

  $("restartBtn").addEventListener("click", ()=>{
    clearState();
    window.state = { idx:0, answers:Array(total).fill(undefined), scores:{}, finished:false, order:makeOrder(total) };
    saveState(window.state);
    showScreen("screenQuiz");
    renderQuestion();
    toast("最初から！（シャッフルし直し）");
  });

  $("backBtn").addEventListener("click", back);
  $("skipBtn").addEventListener("click", skipNeutral);

  $("toResultBtn").addEventListener("click", ()=>{
    goResult();
  });

  // ---------- boot後に復元描画 ----------
  // PART1のbootが画面切替だけしてる想定なので、クイズ画面なら描画
  setTimeout(()=>{
    ensureOrder();
    if(!$("screenQuiz").classList.contains("hide")){
      renderQuestion();
    }
    if(state.finished){
      goResult();
    }
  }, 0);

})();
</script>
  
  <!-- ここにパート3を貼る -->
<script>
/* =========================
   (偽)えむびーてぃーあいPlus - PART3（作り直し完全版）
   ✅ 界隈をデカ表示（結果画面で一番目立つ）
   ✅ 結果を長文化（強み/弱点/恋愛/職業/YouTube/伸ばし方/地雷）
   ✅ 「界隈が2つしか出ない」問題を改善（判定ロジック強化）
   ✅ 既存の暫定result処理より優先して動く（captureで止める）
========================= */

(function(){
  // ---------- 安全に参照 ----------
  const $ = (id)=>document.getElementById(id);
  const Q = (window.QUESTIONS && window.QUESTIONS.length) ? window.QUESTIONS : [];

  // PART1/2側の state / showScreen / saveState を使う前提
  if(typeof state === "undefined"){
    console.warn("state が見つからん。PART1/2の順番を確認してな。");
    return;
  }
  if(!Q.length){
    console.warn("QUESTIONS が空。PART2を先に貼れてるか確認してな。");
  }

  // ---------- 追加CSS（界隈をデカ表示） ----------
  (function injectStyle(){
    const css = `
      .bigCat{
        border:1px solid rgba(255,255,255,.18);
        background: rgba(255,255,255,.10);
        padding: 14px 14px;
        border-radius: 18px;
        margin: 4px 0 12px;
        backdrop-filter: blur(8px);
      }
      .bigCat .k{
        font-size: 12px;
        color: rgba(255,255,255,.70);
        letter-spacing: .08em;
        text-transform: uppercase;
      }
      .bigCat .v{
        margin-top: 4px;
        font-weight: 1000;
        line-height: 1.12;
        font-size: clamp(22px, 4.8vw, 42px);
        background: linear-gradient(90deg, rgba(110,242,255,.95), rgba(185,156,255,.95), rgba(255,124,158,.95));
        -webkit-background-clip:text;
        background-clip:text;
        color: transparent;
      }
      .bigCat .sub{
        margin-top: 8px;
        font-size: 12px;
        color: rgba(255,255,255,.62);
        line-height: 1.45;
      }
      .longBox{
        margin-top: 10px;
        padding: 12px;
        border-radius: 16px;
        border:1px solid rgba(255,255,255,.14);
        background: rgba(255,255,255,.06);
      }
      .longBox h4{
        margin:0 0 8px 0;
        font-size: 13px;
        color: rgba(255,255,255,.86);
        letter-spacing:.02em;
      }
      .longBox p, .longBox li{
        margin:0;
        font-size: 13px;
        color: rgba(255,255,255,.68);
        line-height: 1.6;
      }
      .longBox ul{ margin: 0; padding-left: 18px; }
    `;
    const tag = document.createElement("style");
    tag.textContent = css;
    document.head.appendChild(tag);
  })();

  // ---------- 5界隈 ----------
  const CATS = [
    { key:"SNS",  name:"SNS界隈" },
    { key:"GLAM", name:"夜職・盛り界隈" },
    { key:"GACHI",name:"堅実ガチ勢界隈" },
    { key:"LOVE", name:"恋愛脳界隈" },
    { key:"KAGE", name:"省エネ隠居界隈" },
  ];

  // ---------- 30タイプ（5界隈×6） ----------
  // 6タイプの内訳：E主導 / C主導 / A主導 ×（攻めor守り）＝6
  const TYPES = [
    // ========== SNS界隈 ==========
    {cat:"SNS", idx:0, name:"リプ欄の王（コミュ強）",
      vibe:"ノリと反応速度で勝つSNS型。場の温度を上げる天才。",
      core:["反応が早い","言葉が軽快","空気を明るくできる"],
      trap:["テンションで押し切って疲れがち","雑な一言が刺さる時がある"],
      love:"一緒にふざけられる＋最後はちゃんと話し合える人。束縛強い相手はキツい。",
      job:"営業/広報/接客/配信/イベント。『人前で回す』仕事で強い。",
      media:"バラエティ、配信、街ブラ、即興トーク、企画ドッキリ。"
    },
    {cat:"SNS", idx:1, name:"インプレ古事記（戦略型）",
      vibe:"数字・伸び・導線をゲームとして最適化するSNS型。ABテスト脳。",
      core:["改善が早い","伸びる理由を分解できる","検証→再投稿ができる"],
      trap:["反応＝自分の価値になりやすい","数字が落ちるとメンタル削れる"],
      love:"『現実の生活も大事』を言ってくれる安定系。応援しつつ止められる相手◎。",
      job:"マーケ/広告/企画/分析/運用。数字で戦う仕事。",
      media:"マーケ解説、伸び方分析、ビジネスバラエティ、検証系。"
    },
    {cat:"SNS", idx:2, name:"Twitter裏垢悪口マシーン",
      vibe:"言語化で感情処理するSNS型。面白いが、疲れると刃が出る。",
      core:["言葉で整理できる","面白い切り返し","洞察が鋭い"],
      trap:["言葉が鋭すぎる事故","悪口で気持ち良くなりやすい（沼）"],
      love:"一言で傷つかず、境界線を一緒に作れる人。ちゃんと止めてくれる相手。",
      job:"編集/ライター/運用/リサーチ/企画。言葉で価値を作る仕事。",
      media:"考察/炎上分析/ディベート/ニュース解説。コメント欄も読む。"
    },
    {cat:"SNS", idx:3, name:"炎上回避の危機管理人",
      vibe:"地雷察知で守り切るSNS型。やらかしを未然に潰す。",
      core:["慎重","事実確認できる","守りが固い"],
      trap:["安全に寄りすぎて動けない時がある","疑い深くなる"],
      love:"情緒が安定してて話し合いできる人。安心供給できる相手が向く。",
      job:"CS/運用保守/総務寄り/品質管理。事故らない運用。",
      media:"ニュース、ガジェット、丁寧な解説、検証レビュー。"
    },
    {cat:"SNS", idx:4, name:"自撮り研究所（研究員）",
      vibe:"映えをセンスじゃなく研究で作るSNS型。改善速度が武器。",
      core:["改善癖","撮影/文章の検証","努力が可視化できる"],
      trap:["比較で病みやすい","完璧主義になりがち"],
      love:"努力をちゃんと褒める人。外見だけじゃなく過程も見てくれる相手。",
      job:"デザイン/撮影/編集/美容。改善→反映が早い職。",
      media:"美容・垢抜け・検証、ビフォアフ、短尺も好き。"
    },
    {cat:"SNS", idx:5, name:"ROM専の観測者",
      vibe:"出さずに深掘りで勝つSNS型。静かに鋭い。",
      core:["観察眼","長期で積める","深い洞察"],
      trap:["発信が遅れて機会損失","考えすぎて動けない"],
      love:"急かさず待てる人。静かな時間を共有できる相手。",
      job:"分析/研究/企画/制作/開発寄り。",
      media:"長尺解説、ドキュメンタリー、考察。"
    },

    // ========== 夜職・盛り界隈 ==========
    {cat:"GLAM", idx:0, name:"カリスマホスト（営業脳）",
      vibe:"相手の欲しい言葉と温度を読んで出す盛り界隈。空気で勝つ。",
      core:["人の反応読む","言葉選び上手い","場を回せる"],
      trap:["やりすぎると操作っぽく見える","自分が空っぽになる"],
      love:"依存を作らず対等に笑える人。境界線が作れる相手。",
      job:"営業/交渉/広報/司会/接客。相手に合わせて勝てる仕事。",
      media:"トーク番組、接客術、心理テク、密着系。"
    },
    {cat:"GLAM", idx:1, name:"整形マシーン（改善鬼）",
      vibe:"コンプレックスを行動で潰す盛り界隈。変化が早い。",
      core:["改善と継続","自己投資ができる","結果が出やすい"],
      trap:["沼に入ると終わらない","他人比較で疲れる"],
      love:"努力をバカにしない人。中身も見てくれる相手◎。",
      job:"美容/デザイン/編集/フィットネス。改善の積み上げが武器。",
      media:"美容医療、検証、ビフォアフ、整う系。"
    },
    {cat:"GLAM", idx:2, name:"夜職女級プライドウーマン",
      vibe:"舐められたくない＆雑に扱われたくない盛り界隈。自尊心で守る。",
      core:["自分の価値を守れる","強気に出れる","境界線が引ける"],
      trap:["柔らかさが減ると誤解される","プライドで損する時がある"],
      love:"誠実で筋が通る人。駆け引きより対話できる相手。",
      job:"販売/美容/ブランディング/接客。自分を商品化できる。",
      media:"恋リア、美容、垢抜け、ホスト密着（観察含む）。"
    },
    {cat:"GLAM", idx:3, name:"ブランド脳（世界観）",
      vibe:"雰囲気・世界観が命の盛り界隈。雑さが無理。",
      core:["世界観づくり","美意識","丁寧さ"],
      trap:["理想が高く疲れる","雑な環境で消耗する"],
      love:"丁寧で嘘が少ない人。扱いが雑な相手は相性×。",
      job:"クリエイティブ/ディレクション/店舗づくり。",
      media:"Vlog、ルームツアー、映像美、ルーティン。"
    },
    {cat:"GLAM", idx:4, name:"ギャップ姫（内側堅実）",
      vibe:"外は派手、中は計画的。表裏を回せる盛り界隈。",
      core:["二面性を使える","裏で段取り","現実も見れる"],
      trap:["気を張りすぎる","本音が出にくい"],
      love:"表面で判断しない人。内側の堅実さを見抜く相手◎。",
      job:"企画/運営/マネジメント。表も裏も回す系。",
      media:"バラエティ+学び系のハイブリッド。"
    },
    {cat:"GLAM", idx:5, name:"盛り耐性ゼロ（正直者）",
      vibe:"盛る文化は好きでも嘘は苦手。素直で不器用。",
      core:["誠実","信用される","ブレない"],
      trap:["器用に立ち回れず損する","場の圧で疲れる"],
      love:"比較や評価を持ち込まない人。安心して素直でいられる相手。",
      job:"専門職/職人気質。正直さが信頼になる仕事。",
      media:"手元作業、料理、職人、ゆる日常。"
    },

    // ========== 堅実ガチ勢界隈 ==========
    {cat:"GACHI", idx:0, name:"ガチ予定表マン",
      vibe:"締切・段取り・リスク回避で勝つ堅実界隈。先に詰めて勝つ。",
      core:["計画","継続","事故らない"],
      trap:["柔軟さが落ちる","他人にも同じ精度を求めがち"],
      love:"約束守る人。生活が整ってる相手が相性◎。",
      job:"事務/PM/運用/経理/管理。仕組み化で勝つ。",
      media:"解説/勉強/作業用BGM/効率系。"
    },
    {cat:"GACHI", idx:1, name:"ミス0教（再発防止）",
      vibe:"やらかしを事件として処理できる堅実界隈。原因→対策が自然。",
      core:["再発防止","冷静","品質意識"],
      trap:["自分に厳しすぎる","失敗が怖くなる"],
      love:"安心感のある安定系。感情の波が少ない相手が向く。",
      job:"品質管理/監査/保守/医療事務寄り。ミス潰し。",
      media:"検証、レビュー、比較、マニュアル系。"
    },
    {cat:"GACHI", idx:2, name:"コスパ神（最適化）",
      vibe:"損得と効率で判断する堅実界隈。合理性が武器。",
      core:["合理","比較","最適化"],
      trap:["感情の説明が雑に見える","冷たいと言われる時がある"],
      love:"合理性を理解してくれる人。感情だけで詰めない相手。",
      job:"データ/金融/購買/分析。比較して決める仕事。",
      media:"投資/節約/ガジェット/ビジネス。"
    },
    {cat:"GACHI", idx:3, name:"責任感モンスター",
      vibe:"人が逃げる場面で逃げない堅実界隈。背負って回す。",
      core:["責任感","信頼","やり切る"],
      trap:["抱え込み","燃え尽き","他人に頼めない"],
      love:"『休んでいい』と言える人。背負いすぎを止めてくれる相手。",
      job:"リーダー/現場管理/教育係。信頼で回す。",
      media:"スポーツ、挑戦ドキュメンタリー、努力系。"
    },
    {cat:"GACHI", idx:4, name:"静かな努力家",
      vibe:"派手に言わず淡々と積む堅実界隈。結果で黙らせる。",
      core:["継続","集中","内側が強い"],
      trap:["損しても言わない","評価が遅れる"],
      love:"干渉しすぎない人。信頼で繋がれる相手。",
      job:"研究/技術/制作。黙々と強い。",
      media:"長尺、作業、解説、ドキュメンタリー。"
    },
    {cat:"GACHI", idx:5, name:"逆転狙いの追い込み職人",
      vibe:"普段ゆるいのに締切前に覚醒する堅実界隈。短期火力。",
      core:["追い込み火力","集中","修羅場対応"],
      trap:["普段の準備が薄くなる","波が出る"],
      love:"波を責めず見守れる人。責めない相手が向く。",
      job:"制作/編集/ライティング。締切がある仕事◎。",
      media:"ストーリー性ある企画、短期集中、成長系。"
    },

    // ========== 恋愛脳界隈 ==========
    {cat:"LOVE", idx:0, name:"秒速切り替えマン",
      vibe:"失敗しても切り替えが早い恋愛界隈。恋愛を人生の一部として扱える。",
      core:["回復が早い","軽やか","次へ進める"],
      trap:["相手が重いと冷める","深掘りが雑になる"],
      love:"テンポが合う人。重くなりすぎない相手。",
      job:"営業/企画/挑戦系。切替力が武器。",
      media:"バラエティ、旅行、企画ドッキリ。"
    },
    {cat:"LOVE", idx:1, name:"恋愛裁判官（白黒）",
      vibe:"曖昧が嫌い。約束と筋を重く扱う恋愛界隈。",
      core:["筋が通る","誠実","話し合いできる"],
      trap:["白黒つけすぎて疲れる","融通が利きにくい"],
      love:"逃げずに話し合いできる人。誠実な相手が必須。",
      job:"交渉/相談/調整。整合性が要る仕事。",
      media:"恋リア、討論、心理解説。"
    },
    {cat:"LOVE", idx:2, name:"重めの一途（積み上げ型）",
      vibe:"信頼を積む恋愛界隈。雑に扱われると一気に冷める。",
      core:["一途","誠実","信頼を育てる"],
      trap:["傷つくと深い","期待が重くなる"],
      love:"言葉と行動が一致する人。浮つかない相手◎。",
      job:"教育/ケア/対人支援。信頼の積み上げ。",
      media:"ストーリー重視、長編ドラマ/映画。"
    },
    {cat:"LOVE", idx:3, name:"安心供給装置",
      vibe:"相手の不安を減らす恋愛界隈。優しいが義務化すると疲れる。",
      core:["共感","安心感","寄り添い"],
      trap:["相手に吸われる","我慢しがち"],
      love:"感謝を言える人。甘えすぎない相手が◎。",
      job:"CS/福祉/受付/サポート。安心を作る仕事。",
      media:"癒し、日常、料理、動物。"
    },
    {cat:"LOVE", idx:4, name:"好きバレ職人（匂わせ）",
      vibe:"空気で伝える恋愛界隈。ロマンも事故も起きる。",
      core:["雰囲気作り","表現","気遣い"],
      trap:["察して欲しいが増える","ズレた時に地獄"],
      love:"察し力高い人 or ちゃんと確認してくれる人。",
      job:"広報/接客/表現系。空気づくり。",
      media:"恋愛ショート、共感系、Vlog。"
    },
    {cat:"LOVE", idx:5, name:"恋愛より自分軸",
      vibe:"恋愛も大事だが主導権は自分。依存が苦手。",
      core:["自立","尊重","ブレない"],
      trap:["距離が冷たく見える","甘え下手"],
      love:"自立してて束縛しない人。尊重ができる相手。",
      job:"専門職/クリエイティブ/個人で成果。",
      media:"自己成長、学び、ルーティン。"
    },

    // ========== 省エネ隠居界隈 ==========
    {cat:"KAGE", idx:0, name:"省エネ仙人",
      vibe:"無駄な争いを避けて平和に生きる隠居界隈。安定が好き。",
      core:["平和主義","落ち着き","燃費が良い"],
      trap:["刺激が減って停滞","逃げ癖が出る時がある"],
      love:"静かな時間を共有できる人。落ち着いてる相手。",
      job:"裏方/事務/制作/集中作業。",
      media:"散歩、ASMR、作業、落ち着くやつ。"
    },
    {cat:"KAGE", idx:1, name:"人見知りのプロ",
      vibe:"最初は固いが信頼すると深い隠居界隈。少数精鋭。",
      core:["信頼が深い","裏切らない","少人数で強い"],
      trap:["初速が遅い","誤解されやすい"],
      love:"距離を詰めすぎない人。信頼構築できる相手。",
      job:"研究/制作/職人気質。",
      media:"淡々系、考察、解説。"
    },
    {cat:"KAGE", idx:2, name:"メンタル防壁（ガード硬）",
      vibe:"傷つく前に守る隠居界隈。安全圏で強い。",
      core:["自己管理","慎重","壊れにくい"],
      trap:["心を開くのが遅い","疑い深くなる"],
      love:"詰めずに理解する人。安心感ある相手。",
      job:"運用保守/安定職/ルーチン強い仕事。",
      media:"レビュー、比較、検証。"
    },
    {cat:"KAGE", idx:3, name:"空気読む観察者",
      vibe:"喋らないけど見てる隠居界隈。変化に気づく。",
      core:["察し","観察眼","沈黙が平気"],
      trap:["言わないで損する","抱え込む"],
      love:"沈黙を気まずくしない人。自然体の相手。",
      job:"サポート/編集/調整役/裏方。",
      media:"ドキュメンタリー、雰囲気Vlog、映画。"
    },
    {cat:"KAGE", idx:4, name:"静かな反骨",
      vibe:"波風立てないが芯が強い隠居界隈。理不尽は覚えてる。",
      core:["芯","誠実","筋を通す"],
      trap:["我慢で溜める","爆発すると強い"],
      love:"誠実で尊重できる人。嘘が多い相手は無理。",
      job:"品質/改善/監査/専門職。",
      media:"社会系、考察、討論（見る専）。"
    },
    {cat:"KAGE", idx:5, name:"気分の波サーファー",
      vibe:"出力が波で変わる隠居界隈。波を前提に設計すると強い。",
      core:["柔軟","自分の波を知ってる","無理しない"],
      trap:["安定しないと自己嫌悪","継続が難しい"],
      love:"波を責めない人。休むのを許せる相手。",
      job:"自由度高い制作/編集/在宅寄り。",
      media:"短尺→長尺を気分で行き来。ゆるい企画。"
    },
  ];

  // ---------- 軸（E/C/A）を“そこそこ正確に” ----------
  // PART2でaxesは E/C/A を置いてる前提で読む（無いなら0）
  function calcAxis(){
    const sum = {E:0, C:0, A:0};
    (state.answers||[]).forEach((v,i)=>{
      if(typeof v !== "number") return;
      const ax = Q[i] && Q[i].axes ? Q[i].axes : null;
      if(!ax) return;
      if(ax.E) sum.E += v * ax.E;
      if(ax.C) sum.C += v * ax.C;
      if(ax.A) sum.A += v * ax.A;
    });
    return sum;
  }

  // ---------- 界隈スコア（「2つしか出ない」問題を潰す強化版） ----------
  function calcCatScores(){
    const score = {SNS:0, GLAM:0, GACHI:0, LOVE:0, KAGE:0};

    // キーワードをめっちゃ増やす（質問文に出てくる単語ベース）
    const re = {
      SNS: /(投稿|バズ|自撮り|DM|いいね|フォロ|フォロー|拡散|リプ|インプレ|炎上|裏垢|タイムライン|SNS|インスタ|X|ツイ)/i,
      GLAM: /(整形|美容|垢抜け|ブランド|ホスト|夜職|盛り|メイク|スキンケア|外見|見た目|ギャップ)/i,
      GACHI: /(締切|提出|計画|予約|予算|検証|ルール|単位|テスト|再発防止|最適化|記録|管理|効率)/i,
      LOVE: /(恋人|好きな人|告白|嫉妬|失恋|返信|束縛|彼氏|彼女)/i,
      KAGE: /(不安|眠|疲|気まず|距離|黙|放置|様子見|逃げ|休む|メンタル)/i,
    };

    (state.answers||[]).forEach((v,i)=>{
      if(typeof v !== "number") return;
      const q = (Q[i] && Q[i].q) ? Q[i].q : "";
      // 反応の強さ：否定/肯定は重め、中立は軽め
      const w = (v === 0) ? 1 : 2;

      // キーワード加点
      Object.keys(re).forEach(k=>{
        if(re[k].test(q)) score[k] += w;
      });

      // 追加：範囲で補助（PART2の構成上、81-90はSNS寄り、91-100はLOVE寄りなど）
      if(i >= 80 && i <= 89) score.SNS += w;        // 81-90
      if(i >= 90 && i <= 99) score.LOVE += w;       // 91-100
      if(i >= 70 && i <= 79) score.GACHI += w;      // 生活/管理
      if(i >= 40 && i <= 50) score.KAGE += 0.5*w;   // 感情処理はKAGE寄りに少し
    });

    return score;
  }

  function pickBestCats(catScore){
    const arr = Object.entries(catScore).sort((a,b)=>b[1]-a[1]);
    const top1 = arr[0] ? arr[0][0] : "SNS";
    const top2 = arr[1] ? arr[1][0] : "GACHI";
    const top3 = arr[2] ? arr[2][0] : "LOVE";
    return {top1, top2, top3, ordered: arr};
  }

  // ---------- 6タイプの選び方（界隈内の6枠に落とす） ----------
  // maxAxis（E/C/A） × dir（+攻め / -守り）
  function pickType(catKey, axis){
    const pack = TYPES.filter(t=>t.cat===catKey);
    const aE=Math.abs(axis.E), aC=Math.abs(axis.C), aA=Math.abs(axis.A);
    const maxAxis = (aE>=aC && aE>=aA) ? "E" : (aC>=aE && aC>=aA) ? "C" : "A";
    const dir = (axis[maxAxis] >= 0) ? 0 : 1; // 0=攻め 1=守り
    const which = (maxAxis==="E") ? 0 : (maxAxis==="C") ? 1 : 2;
    const idx = dir*3 + which; // 0..5
    return pack[idx] || pack[0];
  }

  // ---------- “長文”生成（スコアに応じて文章の色を変える） ----------
  function levelText(v){
    const a = Math.abs(v);
    if(a >= 10) return "極";
    if(a >= 6)  return "強";
    if(a >= 3)  return "中";
    return "弱";
  }
  function axisExplain(axis){
    const e = axis.E, c=axis.C, a=axis.A;
    const Eline = `外向(E)：${e>=0?"攻め寄り":"守り寄り"}（強さ: ${levelText(e)} / 値: ${e>=0?"+":""}${e}）`;
    const Cline = `計画(C)：${c>=0?"計画寄り":"ノリ寄り"}（強さ: ${levelText(c)} / 値: ${c>=0?"+":""}${c}）`;
    const Aline = `共感(A)：${a>=0?"共感寄り":"ドライ寄り"}（強さ: ${levelText(a)} / 値: ${a>=0?"+":""}${a}）`;
    return {Eline, Cline, Aline};
  }

  function longDescription(typeObj, catKey, cats, axis){
    const catName = (CATS.find(c=>c.key===catKey)||{name:catKey}).name;
    const sub1 = (CATS.find(c=>c.key===cats.top2)||{name:cats.top2}).name;
    const sub2 = (CATS.find(c=>c.key===cats.top3)||{name:cats.top3}).name;

    const ax = axisExplain(axis);

    // “あなたはこういう人物”を長文化（ブレにくい構造）
    const p1 =
`結論：あなたの主戦場は **${catName}**。ただし純粋100%じゃなくて、サブに **${sub1} / ${sub2}** の要素も混ざってるタイプ。
この診断は「気分」じゃなく、やらかし・緊急・人間関係みたいな場面での“反応の癖”を拾ってる。だから当たりやすい。`;

    const p2 =
`あなたの核（タイプ名）：**${typeObj.name}**
ひとことで言うと「${typeObj.vibe}」
強みの出方は、だいたいこの3つで固定される：  
・${typeObj.core[0]}  
・${typeObj.core[1]}  
・${typeObj.core[2]}  
逆に、弱点（事故り方）はこの2つが多い：  
・${typeObj.trap[0]}  
・${typeObj.trap[1]}`;

    const p3 =
`行動の癖（軸の説明）：
- ${ax.Eline}
- ${ax.Cline}
- ${ax.Aline}

※この3軸は「どう振る舞うか」を分解しただけ。良い/悪いじゃない。
ただ、恋愛・仕事・SNS・友達関係は、この3軸の組み合わせでほぼ決まる。`;

    return [p1,p2,p3].join("\n\n");
  }

  function longLove(typeObj, axis){
    const e = axis.E, c=axis.C, a=axis.A;
    const add =
      (a < 0) ? "あなたは“優しさ”を言葉で出すより、行動やルールで出す側。相手が察しないタイプだと誤解されやすいから、最低限だけ言語化すると恋愛が安定する。"
      : "あなたは共感で相手を落ち着かせられる側。だから相手が依存しやすい。『全部背負わない』境界線を作ると恋愛の質が上がる。";
    const add2 =
      (c < 0) ? "ノリで進める恋は楽しいけど、すれ違いも増える。『確認するタイミング』だけ先に決めると事故が減る。"
      : "計画寄りだから、相手に“管理されてる感”を出すと萎えられる時がある。ルールは共有、強制はしない。";
    const add3 =
      (e < 0) ? "守り寄りやから、好きになっても動き出しが遅い。小さくでもアクション（返信・会う頻度）を出すと誤解が減る。"
      : "攻め寄りやから、熱量が高い。相手が追いつかん時は“間”を作ると上手くいく。";

    return [
      `相性の核：${typeObj.love}`,
      `恋愛での伸ばし方：`,
      `・${add}`,
      `・${add2}`,
      `・${add3}`,
      `地雷（これやると詰む）：`,
      `・「言わなくても分かるやろ」放置（誤解が雪だるま）`,
      `・不安のまま詰める（相手を守りに入らせる）`,
    ].join("\n");
  }

  function longJob(typeObj, axis){
    const c = axis.C, e = axis.E;
    const style =
      (c >= 0) ? "あなたは『仕組みで勝つ』側。手順・チェック・テンプレがある環境で伸びる。"
              : "あなたは『瞬発で勝つ』側。変化が多い現場や、短期勝負で火力が出る。";
    const style2 =
      (e >= 0) ? "人前でも勝てる。説明・交渉・見せ方が武器になる。"
              : "裏方で勝てる。分析・制作・改善で静かに強い。";
    return [
      `向いてる職業（コア）：${typeObj.job}`,
      `働き方の癖：`,
      `・${style}`,
      `・${style2}`,
      `職場での“勝ち筋”：`,
      `・得意な場面を先に固定（役割を取る）`,
      `・苦手は“気合”じゃなく“仕組み”で潰す`,
    ].join("\n");
  }

  function longMedia(typeObj, catKey){
    const extra =
      (catKey==="SNS")  ? "コメント欄・反応・伸び方まで含めて“作品”として見がち。"
      : (catKey==="GACHI") ? "学び・比較・検証で『納得』するとハマる。"
      : (catKey==="LOVE")  ? "人間関係の機微があるストーリー系に刺さりやすい。"
      : (catKey==="GLAM")  ? "変化・ビフォアフ・世界観がある映像が刺さりやすい。"
      : "落ち着く空気・長尺・静かな面白さに刺さりやすい。";
    return [
      `好きそうなYouTube/娯楽（コア）：${typeObj.media}`,
      `ハマり方の特徴：${extra}`,
      `おすすめの見方：『気分が落ちた時用』と『テンション上げたい用』で再生リスト分けると神。`,
    ].join("\n");
  }

  // ---------- 表示（界隈をデカく） ----------
  function renderBigCat(catKey, cats){
    const badges = $("badges");
    if(!badges) return;

    const catName = (CATS.find(c=>c.key===catKey)||{name:catKey}).name;
    const sub1 = (CATS.find(c=>c.key===cats.top2)||{name:cats.top2}).name;
    const sub2 = (CATS.find(c=>c.key===cats.top3)||{name:cats.top3}).name;

    // badgesを一旦クリアして、デカ表示を先頭に置く
    badges.innerHTML = "";

    const big = document.createElement("div");
    big.className = "bigCat";
    big.innerHTML = `
      <div class="k">あなたの界隈</div>
      <div class="v">${catName}</div>
      <div class="sub">サブ成分：${sub1} / ${sub2}（混ざってるから、結果が立体的になる）</div>
    `;
    badges.appendChild(big);
  }

  function renderAxisBadges(axis){
    const badges = $("badges");
    if(!badges) return;

    // bigCatの下に小バッジ追加
    const addBadge = (txt)=>{
      const s = document.createElement("span");
      s.className = "badge";
      s.textContent = txt;
      badges.appendChild(s);
    };

    addBadge(`E(外向) ${axis.E>=0?"+":""}${axis.E} / ${levelText(axis.E)}`);
    addBadge(`C(計画) ${axis.C>=0?"+":""}${axis.C} / ${levelText(axis.C)}`);
    addBadge(`A(共感) ${axis.A>=0?"+":""}${axis.A} / ${levelText(axis.A)}`);
    addBadge(`回答 ${state.answers.filter(v=>typeof v==="number").length}/${Q.length || 100}`);
  }

  // ---------- 結果確定 ----------
  function calcAndRenderResult(){
    const axis = calcAxis();
    const catScore = calcCatScores();
    const cats = pickBestCats(catScore);

    const typeObj = pickType(cats.top1, axis);

    // デカ界隈表示
    renderBigCat(cats.top1, cats);
    renderAxisBadges(axis);

    // タイプ名
    $("resultTitle").textContent = typeObj.name;

    // 長文化（desc / love / job / media）
    $("desc").textContent  = longDescription(typeObj, cats.top1, cats, axis);
    $("love").textContent  = longLove(typeObj, axis);
    $("job").textContent   = longJob(typeObj, axis);
    $("media").textContent = longMedia(typeObj, cats.top1);

    // さらに“長文追記ボックス”を各パネル末尾に追加（無ければ追加）
    attachLongBoxes(typeObj, cats.top1, axis, cats);
  }

  function attachLongBoxes(typeObj, catKey, axis, cats){
    // 既に追加済みなら二重に増やさない
    const mark = "__plus_long_boxes__";
    if(window[mark]) return;
    window[mark] = true;

    // 追加内容（精度寄りの「伸ばし方・地雷・取説」）
    const kit = document.createElement("div");
    kit.className = "longBox";
    kit.innerHTML = `
      <h4>取扱説明書（精度寄り）</h4>
      <ul>
        <li><b>最強になる条件：</b>「得意な場面」を先に固定して、苦手は仕組みで潰す。</li>
        <li><b>事故る条件：</b>疲れてるのに無理して、人間関係で雑な一言が出た時。</li>
        <li><b>回復のコツ：</b>睡眠→食事→環境（場所変える）→言語化（短く）で戻る。</li>
      </ul>
    `;

    const kit2 = document.createElement("div");
    kit2.className = "longBox";
    kit2.innerHTML = `
      <h4>次の一手（1週間で変わるやつ）</h4>
      <ul>
        <li>①「やらかし」したら：<b>謝罪 → 対策 → 代案</b>の順でテンプレ化</li>
        <li>② 人間関係で迷ったら：<b>確認（質問）</b>を1回入れて誤解を止める</li>
        <li>③ 継続が苦手なら：<b>毎日やる</b>じゃなく <b>週◯回</b>で設計</li>
      </ul>
    `;

    // どこに挿す：結果画面の最初のパネル（descのパネル）に入れる
    const descP = $("desc");
    if(descP && descP.parentElement){
      descP.parentElement.appendChild(kit);
      descP.parentElement.appendChild(kit2);
    }
  }

  // ---------- 「結果ボタン」優先ハンドラ ----------
  const toResultBtn = $("toResultBtn");
  if(toResultBtn){
    // 先にcaptureで取って、PART2のクリックを止める
    toResultBtn.addEventListener("click", function(ev){
      ev.preventDefault();
      ev.stopPropagation();
      ev.stopImmediatePropagation();

      state.finished = true;
      try{ saveState(state); }catch(e){}
      calcAndRenderResult();
      showScreen("screenResult");
    }, true);
  }

  // ---------- 既に finished で復元する場合 ----------
  setTimeout(()=>{
    if(state && state.finished){
      calcAndRenderResult();
      showScreen("screenResult");
    }
  }, 0);

  // デバッグ用
  window.__EMBTI_PLUS_TYPES = TYPES;
})();
</script>
